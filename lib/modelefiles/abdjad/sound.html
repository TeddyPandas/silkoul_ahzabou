<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nombres en Son + Visualisation 3D</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 20px; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 700px; margin: auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1 { color: #343a40; text-align: center; margin-bottom: 25px; }
        textarea, #abjadInput { width: 100%; min-height: 80px; margin-bottom: 12px; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1rem; line-height: 1.5; }
        #abjadInput { min-height: 40px; }
        #inputVisualizer {
            width: 100%; min-height: 80px; margin-bottom: 12px; padding: 10px; 
            border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; 
            font-size: 1rem; line-height: 1.5; background-color: #e9ecef;
            font-family: monospace; white-space: pre-wrap; word-wrap: break-word;
        }
        #inputVisualizer .token-highlight { background-color: #007bff; color: white; border-radius: 3px; padding: 0 2px; }
        .hidden { display: none !important; }

        /* Styles pour la visualisation 3D */
        #threeJsContainer {
            width: 100%;
            height: 350px; /* Hauteur de la zone de visualisation */
            background-color: #000; /* Fond noir */
            margin-top: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            position: relative;
            overflow: hidden; /* S'assurer que le canvas ne dépasse pas */
            cursor: grab;
        }
         #threeJsContainer:active { cursor: grabbing; }
        #mainCanvas {
            display: block; /* Éviter les petites marges */
            width: 100%;
            height: 100%;
        }

        .controls, .options, .mode-controls > div, .calculator > div { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: #495057; }
        input[type="number"], select { width: 100%; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 0.95rem; }
        .options label { display: inline-block; margin-right: 20px; font-weight: normal;}
        input[type="radio"] { margin-right: 5px; }
        button { padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.2s ease; margin-right: 5px; margin-bottom: 5px;}
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #stopButton { background-color: #dc3545; }
        #stopButton:hover { background-color: #c82333; }
        #calculateAbjadButton { background-color: #28a745; padding: 8px 15px; font-size: 0.9rem; }
        #calculateAbjadButton:hover { background-color: #218838; }
        #downloadButton { background-color: #17a2b8; } 
        #downloadButton:hover { background-color: #138496; } 
        .error { color: #dc3545; margin-top: 10px; font-weight: bold; }
        #visualizationArea, #abjadResult { margin-top: 20px; padding: 12px; border: 1px solid #e0e0e0; min-height: 25px; background-color: #e9ecef; border-radius: 4px; font-style: italic; color: #495057; }
        #abjadResult { font-weight: bold; text-align: center; }
        #downloadStatus { margin-top: 10px; color: #17a2b8; font-weight: bold; text-align: center; min-height: 1.2em; } 
        .info { margin-top: 20px; font-style: italic; color: #6c757d; background-color: #f0f0f0; padding:10px; border-radius:4px; border: 1px dashed #ccc; font-size:0.9em;}
        details { border: 1px solid #ccc; border-radius: 4px; padding: 10px; margin-top: 20px; background-color: #f9f9f9; }
        summary { font-weight: bold; cursor: pointer; color: #0056b3; }
        .explanation-content { margin-top: 10px; line-height: 1.6; }
        .explanation-content h3 { margin-top:15px; color:#343a40; }
        .explanation-content p, .explanation-content ul { margin-bottom:10px; }
        .explanation-content ul { padding-left:20px; }
        .explanation-content code { background-color: #e9ecef; padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        .radio-group { border: 1px solid #eee; padding: 10px; border-radius: 4px; background-color: #fff; }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.164.1/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.164.1/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Nombres en Son + Visualisation 3D</h1>

        <details> 
            <summary>Comment ça marche ? (Cliquez pour dérouler)</summary>
            <div class="explanation-content">
                <h3>Principe Général</h3>
                <p>Cette application transforme une séquence que vous entrez (chiffres, lettres latines, ou lettres arabes) en une série de sons et en une visualisation 3D interactive.</p>

                <h3>Visualisation 3D</h3>
                <p>La zone noire ci-dessous affiche un système de particules qui réagit à la musique. Les particules montent et descendent en fonction des fréquences jouées. Vous pouvez **cliquer et glisser** sur la visualisation pour la faire tourner et zoomer/dézoomer avec la molette.</p>

                <h3>1. Saisie de l'Entrée</h3>
                <p>Vous pouvez entrer :</p>
                <ul>
                    <li><strong>Une suite de nombres :</strong> Séparés par des espaces ou des virgules (ex: <code>1 5 12 8</code>).</li>
                    <li><strong>Un texte en lettres latines :</strong> (ex: <code>Musique CREATIVE</code>). Les lettres sont converties en nombres (a=1, b=2, ..., z=26). Les majuscules (<code>CREATIVE</code>) sont jouées plus fort (accentuées).</li>
                    <li><strong>Un texte en lettres arabes :</strong> (ex: <code>موسيقى</code>). Vous pouvez choisir ci-dessous comment ces lettres sont converties :
                        <ul>
                            <li><strong>Abjad :</strong> Utilise les valeurs numériques traditionnelles (أ=1, ب=2, ي=10, ش=1000).</li>
                            <li><strong>Séquentiel :</strong> Utilise l'ordre alphabétique (أ=1, ب=2, ..., ي=28).</li>
                        </ul>
                    </li>
                </ul>
                <p>Les caractères non reconnus sont généralement ignorés.</p>
                
                <h3>2. Modes de Génération Sonore</h3>
                 <p>Vous avez le choix entre deux modes principaux : <strong>Notes de Musique</strong> (mappe les nombres à des notes de gammes) et <strong>Fréquence Directe</strong> (calcule une fréquence en Hz).</p>
                 <p><strong>Attention :</strong> Le mode Abjad produit des nombres élevés (jusqu'à 1000). En mode "Fréquence Directe", cela peut donner des sons très aigus ; pensez à réduire le "Multiplicateur" si nécessaire.</p>

                <h3>3. Paramètres & Contrôles</h3>
                <p>Vous pouvez régler la durée, la pause, le type d'onde, le gain (volume) et choisir la gamme musicale. Utilisez les boutons "Jouer", "Arrêter" et "Télécharger". Le texte joué est surligné.</p>
                
                <h3>4. Calculateur Abjad</h3>
                <p>Une section ci-dessous vous permet de calculer rapidement la valeur Abjad totale d'un mot ou d'une phrase.</p>
            </div>
        </details>

        <details>
            <summary>Calculateur Abjad (Cliquez pour dérouler/enrouler)</summary>
            <div class="calculator">
                <label for="abjadInput">Entrez un texte arabe :</label>
                <input type="text" id="abjadInput" placeholder="أدخل كلمة هنا">
                <button id="calculateAbjadButton">Calculer la valeur Abjad</button>
                <div id="abjadResult">La valeur Abjad apparaîtra ici.</div>
            </div>
        </details>

        <div id="threeJsContainer">
            <canvas id="mainCanvas"></canvas>
        </div>

        <div class="controls">
            <label for="inputSequence">Entrez votre séquence pour la musique :</label>
            <textarea id="inputSequence" placeholder="Ex: 1 4 5 8 ou 'Creative audio' ou 'سلام' (S=300, L=30, A=1, M=40)"></textarea>
            <div id="inputVisualizer" class="hidden"></div>
        </div>

        <div class="controls radio-group">
             <label style="margin-bottom: 8px;">Méthode de calcul pour l'Arabe (pour le son) :</label>
            <label>
                <input type="radio" name="arabicMappingMethod" value="abjad" checked> Abjad (أ=1, ب=2, ي=10, ش=1000...)
            </label>
            <label>
                <input type="radio" name="arabicMappingMethod" value="sequential"> Séquentiel (أ=1, ب=2, ..., ي=28)
            </label>
        </div>

        <div class="controls">
            <label for="noteDuration">Durée de la note (secondes) :</label>
            <input type="number" id="noteDuration" value="0.4" step="0.05" min="0.1"> 
        </div>
        <div class="controls">
            <label for="pauseDuration">Pause entre les notes (millisecondes) :</label>
            <input type="number" id="pauseDuration" value="50" step="10" min="0">
        </div>
        <div class="controls">
            <label for="oscillatorType">Type d'onde sonore :</label>
            <select id="oscillatorType">
                <option value="sine">Sinusoïdale (Pure)</option>
                <option value="square">Carrée</option>
                <option value="sawtooth">Dent de scie</option>
                <option value="triangle">Triangulaire</option>
            </select>
        </div>
         <div class="controls">
            <label for="accentGain">Gain pour notes accentuées (MAJ latines) (0.1-1.0) :</label>
            <input type="number" id="accentGain" value="1.0" step="0.1" min="0.1" max="1.0">
        </div>
        <div class="controls">
            <label for="normalGain">Gain pour notes normales (0.1-1.0) :</label>
            <input type="number" id="normalGain" value="0.7" step="0.1" min="0.1" max="1.0">
        </div>

        <div class="options">
             <p style="font-weight:500; margin-bottom:8px;">Choisissez le mode de génération sonore :</p>
            <label>
                <input type="radio" name="soundMode" value="notes" checked onchange="toggleModeControls()"> Notes de Musique
            </label>
            <label>
                <input type="radio" name="soundMode" value="frequency" onchange="toggleModeControls()"> Fréquence Directe
            </label>
        </div>

        <div id="notesModeControls" class="mode-controls">
           <div class="controls">
                <label for="scaleType">Type de gamme :</label>
                <select id="scaleType">
                    <option value="chromatic">Chromatique (12 demi-tons)</option>
                    <option value="major">Majeure</option>
                    <option value="naturalMinor">Mineure Naturelle</option>
                    <option value="pentatonicMajor">Pentatonique Majeure</option>
                </select>
            </div>
            <div class="controls">
                <label for="baseFrequencyNotes">Fréq. de base pour la 1ère note de la gamme (Hz - ex: C4=261.63) :</label>
                <input type="number" id="baseFrequencyNotes" value="261.63" step="1" min="20">
            </div>
        </div>

        <div id="frequencyModeControls" class="mode-controls" style="display:none;">
            <div class="controls">
                <label for="baseFrequencyDirect">Fréq. de base pour le mode Direct (Hz) :</label>
                <input type="number" id="baseFrequencyDirect" value="100" step="10" min="20">
            </div>
            <div class="controls">
                <label for="frequencyMultiplierDirect">Multiplicateur pour Fréq. Directe :</label>
                <input type="number" id="frequencyMultiplierDirect" value="20" step="1" min="1"> </div>
        </div>

        <div style="margin-top:25px; display:flex; gap:10px; flex-wrap: wrap;">
            <button id="playButton" style="flex: 1 1 auto;">Jouer la séquence</button>
            <button id="stopButton" style="flex: 1 1 auto;">Arrêter</button>
            <button id="downloadButton" style="flex: 1 1 auto;">Télécharger le Son (WAV)</button> 
        </div>
        
        <div id="visualizationArea">En attente de lecture...</div>
        <div id="downloadStatus"></div> 
        <p id="errorMessage" class="error"></p>
        <p class="info">
            <strong>Info :</strong> Choisissez la méthode Arabe (Abjad/Séquentiel). Majuscules latines accentuées.
        </p>
    </div>

    <script type="module" src="script.js"></script>
</body>
</html>